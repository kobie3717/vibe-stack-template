name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # Security: Secret scanning (runs first, blocks other jobs if secrets found)
  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning

      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.24.3/gitleaks_8.24.3_linux_x64.tar.gz | tar -xz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      - name: Validate gitleaks config
        run: |
          echo "Validating .gitleaks.toml..."
          gitleaks detect --config .gitleaks.toml --source . --no-git --exit-code 0 --verbose 2>&1 | head -20
          echo "✓ Config validated"

      - name: Run gitleaks scan
        run: |
          gitleaks detect --config .gitleaks.toml --source . --report-path results.sarif --report-format sarif
          echo "✓ No secrets detected"

      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
        continue-on-error: true  # Don't fail if SARIF upload has issues

  # Security: Static security validation
  security-validation:
    name: Security Validation
    runs-on: ubuntu-latest
    needs: secrets-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify no wildcard CORS
        run: |
          echo "Checking CORS configuration..."
          if grep -rE "origin:\s*['\"]?\*['\"]?" backend/src/ 2>/dev/null; then
            echo "::error::Wildcard CORS origin found"
            exit 1
          fi
          echo "✓ No wildcard CORS origins"

      - name: Verify rate limiting exists
        run: |
          echo "Checking rate limiting..."
          if [ -f "backend/src/middleware/rateLimiter.ts" ] || [ -f "backend/src/middleware/rateLimiter.js" ]; then
            echo "✓ Rate limiting middleware exists"
          else
            echo "::warning::Rate limiting middleware not found"
          fi

      - name: Verify auth middleware exists
        run: |
          echo "Checking authentication..."
          if grep -rq "jwt\|JWT\|jsonwebtoken" backend/src/middleware/ 2>/dev/null; then
            echo "✓ JWT authentication middleware exists"
          else
            echo "::warning::JWT auth middleware not found"
          fi

      - name: Verify sensitive files are gitignored
        run: |
          echo "Checking .gitignore..."
          for pattern in ".env" "node_modules" "*.key" "*.pem"; do
            if grep -q "$pattern" .gitignore 2>/dev/null; then
              echo "✓ $pattern is gitignored"
            else
              echo "::warning::$pattern may not be gitignored"
            fi
          done

      - name: Validate environment template
        run: |
          if [ -f scripts/validate-env.sh ]; then
            bash scripts/validate-env.sh --template
          else
            echo "No env validation script found"
          fi

  # Stack check: Contract and type alignment
  stack-check:
    name: Stack Check
    runs-on: ubuntu-latest
    needs: secrets-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install root dependencies
        run: npm install

      - name: Install shared dependencies
        run: npm install
        working-directory: ./shared
        if: hashFiles('shared/package.json') != ''

      - name: Build shared types
        run: npm run build
        working-directory: ./shared
        if: hashFiles('shared/package.json') != ''

      - name: Run contract check
        run: bash scripts/contract-check.sh
        if: hashFiles('scripts/contract-check.sh') != ''

  # Backend CI
  backend:
    name: Backend
    runs-on: ubuntu-latest
    needs: secrets-scan

    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db?schema=public
      JWT_SECRET: test_jwt_secret_at_least_32_characters_long
      NODE_ENV: test
      REDIS_URL: redis://localhost:6379
      PORT: 4000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Security audit
        run: npm audit --audit-level=high --omit=dev || echo "::warning::npm audit found vulnerabilities"
        working-directory: .

      - name: Generate Prisma client
        run: npx prisma generate
        if: hashFiles('backend/prisma/schema.prisma') != ''

      - name: Push database schema
        run: npx prisma db push --skip-generate
        if: hashFiles('backend/prisma/schema.prisma') != ''

      - name: Type check
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint
        if: hashFiles('backend/.eslintrc*', 'backend/eslint.config.*') != ''

      - name: Run tests
        run: npm test -- --coverage --forceExit --testPathIgnorePatterns integration
        if: hashFiles('backend/jest.config.*', 'backend/package.json') != ''

      - name: Build
        run: npm run build

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./backend/coverage
          flags: backend
          fail_ci_if_error: false
        if: hashFiles('backend/coverage/') != ''

  # Frontend CI
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: secrets-scan

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Security audit
        run: npm audit --audit-level=high --omit=dev || echo "::warning::npm audit found vulnerabilities"
        working-directory: .

      - name: Type check
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint
        if: hashFiles('frontend/.eslintrc*', 'frontend/eslint.config.*') != ''

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: http://localhost:4000/api

  # E2E Tests (runs on main only)
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379

    env:
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db?schema=public
      JWT_SECRET: test_jwt_secret_at_least_32_characters_long
      NODE_ENV: test
      REDIS_URL: redis://localhost:6379
      PORT: 4000
      VITE_API_URL: http://localhost:4000/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Setup database
        run: |
          npx prisma generate
          npx prisma db push --skip-generate
        working-directory: ./backend
        if: hashFiles('backend/prisma/schema.prisma') != ''

      - name: Build backend
        run: npm run build
        working-directory: ./backend

      - name: Start backend
        run: |
          node dist/index.js &
          sleep 5
        working-directory: ./backend

      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:4000/health > /dev/null 2>&1; then
              echo "Backend is healthy"
              exit 0
            fi
            echo "Waiting for backend... attempt $i/30"
            sleep 1
          done
          exit 1

      - name: Install Playwright
        run: npx playwright install --with-deps chromium
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend

      - name: Run E2E tests
        run: npx playwright test --project=chromium
        working-directory: ./frontend
        if: hashFiles('frontend/playwright.config.*') != ''

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7
